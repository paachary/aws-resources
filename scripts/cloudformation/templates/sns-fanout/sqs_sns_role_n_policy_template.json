{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "AWS CloudFormation template for creating IAM roles and Policies. This will have a dependency for the stack created for installing webapps and lambda function.",

  "Parameters" : {

    "BucketName" : {
      "Description" : "Name of bucket containing source files",
      "Default":"prax-bucket",
      "Type" : "String"
    },

    "SNSSQSStackName" : {
        "Description" : "Template Name of the stack creating SNS Topic and SQS queues",
        "Type": "String",
        "MinLength" : 1,
        "MaxLength" : 255,
        "AllowedPattern" : "^[a-zA-Z][-a-zA-Z0-9]*$",
        "Default" : "SNSFanoutStack"
    },
      
    "SNSPolicy" : {
      "Description" : "Name of SNS Topic",
      "Default":"FanOutSNSTopic",
      "Type" : "String"
    },
      
    "SQSPolicy" : {
      "Description" : "Name of 1st SQS Queue",
      "Default":"FanOutSQSQueue1",
      "Type" : "String"
    },
      
    "DynamoDBPolicy" : {
      "Description" : "Name of 1st SQS Queue",
      "Default":"DynamoDBPolicy",
      "Type" : "String"
    },
      
    "EC2RoleName" : {
      "Description" : "Name of 1st SQS Queue",
      "Default":"EC2FanOutRole",
      "Type" : "String"
    },
      
    "LambdaRoleName" : {
      "Description" : "Name of 1st SQS Queue",
      "Default": "LambdaFanOutRole",
      "Type" : "String"
    }
  },
  "Resources" : {

    "FanOutSNSPolicy" : {
        "Type" : "AWS::IAM::Policy",
        "Properties": {
            "PolicyName" : { "Ref": "SNSPolicy" },
            "Roles" :[ { "Ref" : "EC2FanOutRole" },
                       { "Ref" : "LambdaFanOutRole" }
             ],
            "PolicyDocument" : {
                "Version": "2012-10-17",
                "Statement": [
                    {
                        "Sid": "1",
                        "Effect": "Allow",
                        "Action": [
                            "sns:Publish",
                            "sns:GetTopicAttributes",
                            "sns:DeleteTopic",
                            "sns:CreateTopic",
                            "sns:Subscribe"
                        ],
                        "Resource": [ { "Fn::ImportValue" : {"Fn::Sub": "${SNSSQSStackName}-Topic" } } 
                        ]
                    }
                ]
            }
        }
    },

    "FanOutSQSPolicy" : {
        "Type" : "AWS::IAM::Policy",
        "Properties": {
            "PolicyName" : { "Ref": "SQSPolicy" },
            "Roles" :[ { "Ref" : "EC2FanOutRole" }
             ],
            "PolicyDocument" : {
                "Version": "2012-10-17",
                "Statement": [
                    {
                        "Sid": "2",
                        "Effect": "Allow",
                        "Action": [
                            "sqs:DeleteMessage",
                            "sqs:GetQueueUrl",
                            "sqs:ReceiveMessage",
                            "sqs:DeleteQueue",
                            "sqs:CreateQueue"
                        ],
                        "Resource": [
                            { "Fn::ImportValue" : {"Fn::Sub": "${SNSSQSStackName}-Queue1ARN" } },
                            { "Fn::ImportValue" : {"Fn::Sub": "${SNSSQSStackName}-Queue2ARN" } }
                        ]
                    }
                ]
            }
        }
    },

    "DynamocDBGetPutPolicy" : {
        "Type" : "AWS::IAM::Policy",
        "Properties": {
            "PolicyName" : { "Ref": "DynamoDBPolicy" },
            "Roles" :[ { "Ref" : "EC2FanOutRole" }
             ],
            "PolicyDocument" : {
                "Version": "2012-10-17",
                "Statement": [
                    {
                        "Sid": "2",
                        "Effect": "Allow",
                        "Action": [
                            "dynamodb:BatchGetItem",
                            "dynamodb:BatchWriteItem",
                            "dynamodb:PutItem",
                            "dynamodb:DeleteItem",
                            "dynamodb:GetItem",
                            "dynamodb:Scan",
                            "dynamodb:Query",
                            "dynamodb:UpdateItem"
                        ],
                        "Resource": [
                            { "Fn::ImportValue" : {"Fn::Sub": "${SNSSQSStackName}-DynamoDBTableARNName" } },
                           "arn:aws:dynamodb:*:*:table/*/index/*"
                        ]
                    }
                ]
            }
        }
    },

    "LambdaExecS3VPCPolicy" : {
        "Type" : "AWS::IAM::Policy",
        "Properties": {
            "PolicyName" :"lamdba_exec_s3_vpc_policy",
            "Roles" :[ { "Ref" : "LambdaFanOutRole" }
             ],
            "PolicyDocument" : {
                "Version": "2012-10-17",
                "Statement": [
                    {
                        "Sid": "1",
                        "Effect": "Allow",
                        "Action": [
                            "logs:CreateLogGroup",
                            "logs:CreateLogStream",
                            "logs:PutLogEvents"
                        ],
                        "Resource": [ 
                           "arn:aws:logs:*:*:*"
                        ]
                    },
                    {
                        "Sid": "2",
                        "Effect": "Allow",
                        "Action": [
                              "s3:GetObject"
                        ],
                        "Resource": [ 
                             {"Fn::Sub": "arn:aws:s3:::${BucketName}/security.csv" }
                        ]
                    },
                    {
                        "Effect": "Allow",
                        "Action": [
                            "ec2:Describe*",
                            "ec2:CreateNetworkInterface",
                            "ec2:DescribeNetworkInterfaces",
                            "ec2:DeleteNetworkInterface"
                        ],
                        "Resource": [
                            "*"
                        ]
                    }
                ]
            }
        }
    },

    "EC2FanOutRole" : {
       "Type" : "AWS::IAM::Role",
       "Properties" : {
           "RoleName" : { "Ref" : "EC2RoleName" },
           "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [ { 
                    "Effect": "Allow", 
                    "Principal": 
                        {"Service": ["ec2.amazonaws.com"] }, 
                          "Action": ["sts:AssumeRole"] 
                   }
                ]
           }
       }
    },

    "LambdaFanOutRole" : {
       "Type" : "AWS::IAM::Role",
       "Properties" : {
           "RoleName" : { "Ref" : "LambdaRoleName" },
           "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [ { 
                    "Effect": "Allow", 
                    "Principal": 
                        {"Service": ["lambda.amazonaws.com"] }, 
                          "Action": ["sts:AssumeRole"] 
                   }
                ]
           }
       }
    }
  },

  "Outputs" : {
      "EC2FanOutRoleARN" : {
          "Description" : "ARN for EC2 Fanout role",
          "Value" :  { "Ref": "EC2FanOutRole" },
          "Export" : { "Name" : {"Fn::Sub" : "${AWS::StackName}-EC2Role" } }
      },

      "LambdaFanOutRoleARN" : {
          "Description" : "ARN for Lambda Fanout role",
          "Value" :  { "Ref": "LambdaFanOutRole" },
          "Export" : { "Name" : {"Fn::Sub" : "${AWS::StackName}-LambdaRole" } }
      }
  }
}
